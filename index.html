<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RADD - Interactive Map with Shared Pins</title>
  
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  
  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
    }
    
    #map {
      height: 100%;
      width: 100%;
    }
    
    #controls {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 1000;
      background: white;
      padding: 10px;
      border-radius: 4px;
      box-shadow: 0 1px 5px rgba(0,0,0,0.4);
      max-width: 300px;
    }
    
    #pin-list {
      position: absolute;
      bottom: 20px;
      left: 10px;
      z-index: 1000;
      background: white;
      padding: 10px;
      border-radius: 4px;
      box-shadow: 0 1px 5px rgba(0,0,0,0.4);
      max-width: 300px;
      max-height: 200px;
      overflow-y: auto;
    }
    
    .button {
      background-color: #4CAF50;
      border: none;
      color: white;
      padding: 8px 16px;
      text-align: center;
      text-decoration: none;
      display: inline-block;
      font-size: 14px;
      margin: 4px 2px;
      cursor: pointer;
      border-radius: 4px;
    }
    
    .button.cancel {
      background-color: #f44336;
    }
    
    .button:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
    }
    
    textarea {
      width: 100%;
      min-height: 60px;
      margin: 5px 0;
      padding: 5px;
      box-sizing: border-box;
    }
    
    .pin-item {
      padding: 5px;
      margin-bottom: 5px;
      border-bottom: 1px solid #eee;
      cursor: pointer;
    }
    
    .pin-item:hover {
      background-color: #f5f5f5;
    }
    
    .status {
      color: #4CAF50;
      font-size: 12px;
      margin-top: 5px;
      display: none;
    }
    
    #delete-pin {
      background-color: #f44336;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  
  <div id="controls">
    <button id="add-pin" class="button">Add Pin</button>
    <div id="pin-info-container">
      <textarea id="pin-description" placeholder="Enter description for this pin"></textarea>
      <button id="save-pin" class="button">Save Pin</button>
      <button id="delete-pin" class="button">Delete Pin</button>
    </div>
    <div id="status-message" class="status"></div>
  </div>
  
  <div id="pin-list">
    <h3>Pins</h3>
    <div id="pins-container"></div>
  </div>
  
  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  
  <!-- Firebase App -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  
  <!-- Firebase Database -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  
  <script>
    // Wait for DOM content to load
    document.addEventListener("DOMContentLoaded", function() {
      // Initialize Firebase
      const firebaseConfig = {
        apiKey: "AIzaSyD6X19rtnpFKKElYRmY8dO_ZmWnXfhXyM0",
        authDomain: "radd-86f5f.firebaseapp.com",
        databaseURL: "https://radd-86f5f-default-rtdb.firebaseio.com",
        projectId: "radd-86f5f",
        storageBucket: "radd-86f5f.firebasestorage.app",
        messagingSenderId: "958503415106",
        appId: "1:958503415106:web:e169eceec47aaf7187ecdb",
        measurementId: "G-NRJ2NL8G68"
      };
      
      try {
        firebase.initializeApp(firebaseConfig);
        console.log("Firebase initialized successfully");
      } catch (error) {
        console.error("Firebase initialization error:", error);
        alert("Error initializing Firebase. See console for details.");
        return;
      }
      
      // Initialize map
      const map = L.map('map').setView([37.7749, -122.4194], 13);
      
      // Add tile layer (base map)
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
      }).addTo(map);
      
      // Reference to the pins in Firebase
      const pinsRef = firebase.database().ref('pins');
      
      // Track all markers
      const markers = {};
      
      // Track the currently selected pin
      let selectedPin = null;
      let addingPin = false;
      
      // UI elements
      const addPinButton = document.getElementById('add-pin');
      const pinInfoContainer = document.getElementById('pin-info-container');
      const pinDescription = document.getElementById('pin-description');
      const savePinButton = document.getElementById('save-pin');
      const deletePinButton = document.getElementById('delete-pin');
      const statusMessage = document.getElementById('status-message');
      const pinsContainer = document.getElementById('pins-container');
      
      // Initially disable save and delete buttons until a pin is selected
      savePinButton.disabled = true;
      deletePinButton.disabled = true;
      
      // Add a new pin
      addPinButton.addEventListener('click', function() {
        if (addingPin) {
          // Cancel adding pin
          addingPin = false;
          addPinButton.textContent = 'Add Pin';
          addPinButton.classList.remove('cancel');
          map.getContainer().style.cursor = '';
        } else {
          // Start adding pin
          addingPin = true;
          addPinButton.textContent = 'Cancel';
          addPinButton.classList.add('cancel');
          map.getContainer().style.cursor = 'crosshair';
          showStatus('Click on the map to add a pin');
        }
      });
      
      // Save pin description
      savePinButton.addEventListener('click', function() {
        if (selectedPin) {
          const description = pinDescription.value.trim();
          
          // Update in Firebase
          pinsRef.child(selectedPin).update({
            description: description
          }).then(() => {
            showStatus('Pin updated successfully');
            savePinButton.disabled = true;
          }).catch(error => {
            console.error('Error updating pin: ', error);
            showStatus('Error updating pin', 'error');
          });
        }
      });
      
      // Delete a pin
      deletePinButton.addEventListener('click', function() {
        if (selectedPin) {
          if (confirm('Are you sure you want to delete this pin?')) {
            // Remove from Firebase
            pinsRef.child(selectedPin).remove()
              .then(() => {
                showStatus('Pin deleted successfully');
                clearSelection();
              }).catch(error => {
                console.error('Error deleting pin: ', error);
                showStatus('Error deleting pin', 'error');
              });
          }
        }
      });
      
      // Enable save button when pin description changes
      pinDescription.addEventListener('input', function() {
        if (selectedPin) {
          savePinButton.disabled = false;
        }
      });
      
      // Map click handler to add pins
      map.on('click', function(e) {
        if (addingPin) {
          const timestamp = Date.now().toString();
          const newPin = {
            id: timestamp,
            latitude: e.latlng.lat,
            longitude: e.latlng.lng,
            description: '',
            timestamp: firebase.database.ServerValue.TIMESTAMP
          };
          
          // Save to Firebase
          pinsRef.child(timestamp).set(newPin)
            .then(() => {
              addingPin = false;
              addPinButton.textContent = 'Add Pin';
              addPinButton.classList.remove('cancel');
              map.getContainer().style.cursor = '';
              showStatus('Pin added successfully');
            })
            .catch(error => {
              console.error('Error adding pin: ', error);
              showStatus('Error adding pin', 'error');
            });
        }
      });
      
      // Clear the current selection
      function clearSelection() {
        selectedPin = null;
        pinDescription.value = '';
        savePinButton.disabled = true;
        deletePinButton.disabled = true;
      }
      
      // Show a status message
      function showStatus(message, type = 'success') {
        statusMessage.textContent = message;
        statusMessage.style.display = 'block';
        statusMessage.style.color = type === 'success' ? '#4CAF50' : '#f44336';
        
        // Hide after 3 seconds
        setTimeout(() => {
          statusMessage.style.display = 'none';
        }, 3000);
      }
      
      // Update the pins list in the UI
      function updatePinsList() {
        pinsContainer.innerHTML = '';
        
        // Convert markers object to array for sorting
        const markerEntries = Object.entries(markers);
        
        // If there are no pins, show a message
        if (markerEntries.length === 0) {
          const noPin = document.createElement('div');
          noPin.textContent = 'No pins added yet.';
          pinsContainer.appendChild(noPin);
          return;
        }
        
        // Sort pins by timestamp (newest first)
        const sortedEntries = markerEntries.sort((a, b) => {
          const timestampA = a[1].options.timestamp || 0;
          const timestampB = b[1].options.timestamp || 0;
          return timestampB - timestampA;
        });
        
        let index = 1;
        sortedEntries.forEach(([pinId, marker]) => {
          const item = document.createElement('div');
          item.className = 'pin-item';
          
          // Format the coordinates
          const lat = marker.getLatLng().lat.toFixed(6);
          const lng = marker.getLatLng().lng.toFixed(6);
          
          let text = `Pin ${index}: [${lat}, ${lng}]`;
          if (marker.options.description) {
            text += ` - ${marker.options.description}`;
          }
          
          item.textContent = text;
          
          // Click to select this pin
          item.addEventListener('click', function() {
            selectPin(pinId);
            map.setView(marker.getLatLng(), 15);
          });
          
          pinsContainer.appendChild(item);
          index++;
        });
      }
      
      // Select a pin for editing
      function selectPin(pinId) {
        selectedPin = pinId;
        const marker = markers[pinId];
        
        if (marker) {
          pinDescription.value = marker.options.description || '';
          deletePinButton.disabled = false;
          savePinButton.disabled = true; // Enable only when changes are made
        }
      }
      
      // Listen for pins added to Firebase
      pinsRef.on('child_added', snapshot => {
        const pin = snapshot.val();
        const pinId = snapshot.key;
        
        if (!pin || !pin.latitude || !pin.longitude) {
          console.error('Invalid pin data:', pin);
          return;
        }
        
        try {
          // Create a marker
          const marker = L.marker([pin.latitude, pin.longitude], {
            title: pin.description || 'Pin',
            id: pinId,
            description: pin.description || '',
            timestamp: pin.timestamp
          }).addTo(map);
          
          // Store in our markers object
          markers[pinId] = marker;
          
          // Add click handler
          marker.on('click', function() {
            selectPin(pinId);
          });
          
          // Update the pins list
          updatePinsList();
        } catch (error) {
          console.error('Error creating marker:', error);
        }
      });
      
      // Listen for pins changed in Firebase
      pinsRef.on('child_changed', snapshot => {
        const pin = snapshot.val();
        const pinId = snapshot.key;
        const marker = markers[pinId];
        
        if (marker) {
          marker.options.description = pin.description || '';
          marker.setTooltipContent(pin.description || 'Pin');
          
          // If this is the currently selected pin, update the description field
          if (selectedPin === pinId) {
            pinDescription.value = pin.description || '';
            savePinButton.disabled = true;
          }
          
          // Update the pins list
          updatePinsList();
        }
      });
      
      // Listen for pins removed from Firebase
      pinsRef.on('child_removed', snapshot => {
        const pinId = snapshot.key;
        const marker = markers[pinId];
        
        if (marker) {
          // Remove the marker from the map
          map.removeLayer(marker);
          
          // Remove from our markers object
          delete markers[pinId];
          
          // If this was the selected pin, clear the selection
          if (selectedPin === pinId) {
            clearSelection();
          }
          
          // Update the pins list
          updatePinsList();
        }
      });
      
      // Add tooltips to markers to show their descriptions
      function addTooltipToMarker(marker, description) {
        if (description && description.trim() !== '') {
          marker.bindTooltip(description);
        }
      }
      
      // Handle errors
      pinsRef.on('child_added', error => {
        if (error) {
          console.error('Error fetching pins:', error);
        }
      });
    });
  </script>
</body>
</html>
